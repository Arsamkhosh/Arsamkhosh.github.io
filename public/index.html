<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ArsamChat با ورود و ثبت‌نام</title>
<style>
body{margin:0;font-family:tahoma,arial;background:#0f1724;color:#e6eef8;display:flex;height:100vh}
.left{width:300px;background:#0b1220;border-left:1px solid rgba(255,255,255,0.03);padding:12px;display:flex;flex-direction:column;gap:12px}
.brand{font-weight:700;font-size:18px}
.users{flex:1;overflow:auto;padding-top:8px}
.user-item{padding:8px;border-radius:8px;margin-bottom:6px;cursor:pointer;background:transparent}
.user-item:hover{background:rgba(255,255,255,0.02)}
.main{flex:1;display:flex;flex-direction:column}
.chat-header{padding:12px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.msg{max-width:70%;padding:8px 10px;border-radius:10px}
.msg.me{align-self:flex-end;background:#ffecd6;color:#071328}
.msg.other{align-self:flex-start;background:rgba(255,255,255,0.03)}
.meta{font-size:12px;color:#aab3c0;margin-bottom:6px}
.composer{padding:12px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px}
input[type="text"],input[type="password"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
button{padding:10px 12px;border-radius:8px;border:none;background:#ff6b35;color:#071328;font-weight:700;cursor:pointer}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(7,10,18,0.7), rgba(7,10,18,0.9));z-index:50}
.box{background:#071022;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:360px}
.small{font-size:13px;color:#9aa6b1}
</style>
</head>
<body>

<div class="overlay" id="loginOverlay">
  <div class="box">
    <h3>ورود / ثبت‌نام</h3>
    <input id="username" placeholder="نام کاربری" /><br/><br/>
    <input id="password" type="password" placeholder="رمز عبور" /><br/><br/>
    <button id="registerBtn">ثبت‌نام</button>
    <button id="loginBtn">ورود</button>
    <div id="loginMsg" class="small" style="color:#ffb4a9;margin-top:8px"></div>
  </div>
</div>

<div class="left">
  <div class="brand">ArsamChat</div>
  <div class="small">کاربر: <span id="meName">—</span></div>
  <div class="small">برای پیام خصوصی روی نام کاربر کلیک کن.</div>
  <div style="font-weight:700;margin-top:6px">آنلاین‌ها</div>
  <div id="users" class="users"></div>
</div>

<div class="main">
  <div class="chat-header">
    <div id="targetTitle">عمومی (همه)</div>
    <div id="status" class="small">قطع</div>
  </div>
  <div id="messages" class="messages"></div>
  <div class="composer">
    <input id="txt" placeholder="پیام خود را بنویس..." />
    <button id="sendBtn">ارسال</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const overlay = document.getElementById('loginOverlay');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');

const meNameEl = document.getElementById('meName');
const usersEl = document.getElementById('users');
const messagesEl = document.getElementById('messages');
const txt = document.getElementById('txt');
const sendBtn = document.getElementById('sendBtn');
const statusEl = document.getElementById('status');
const targetTitle = document.getElementById('targetTitle');

let myName = null;
let currentTarget = null;

function addMessage(msg) {
  const el = document.createElement('div');
  el.className = 'msg ' + (msg.from===myName?'me':'other');
  const meta = document.createElement('div');
  meta.className='meta';
  meta.textContent = `${msg.from}${msg.to?' → '+msg.to:''} • ${new Date(msg.ts).toLocaleTimeString()}`;
  const text = document.createElement('div');
  text.textContent = msg.text;
  el.appendChild(meta);
  el.appendChild(text);
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function renderUsers(list){
  usersEl.innerHTML='';
  list.forEach(u=>{
    const div=document.createElement('div');
    div.className='user-item online';
    div.textContent=u;
    div.addEventListener('click',()=>{currentTarget=u===myName?null:u; targetTitle.textContent=currentTarget?'خصوصی → '+u:'عمومی (همه)';});
    usersEl.appendChild(div);
  });
}

socket.on('connect',()=>statusEl.textContent='متصل');
socket.on('disconnect',()=>statusEl.textContent='قطع');
socket.on('user_list', list=>renderUsers(list));
socket.on('message', msg=>{
  if(!msg.to||msg.to===myName||msg.from===myName) addMessage(msg);
});

function loginOrRegister(url){
  fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:usernameInput.value,password:passwordInput.value})})
  .then(r=>r.json()).then(res=>{
    if(res.ok){
      myName=usernameInput.value;
      meNameEl.textContent=myName;
      overlay.style.display='none';
      socket.emit('registerSocket', myName);
    } else loginMsg.textContent=res.error;
  });
}

registerBtn.onclick=()=>loginOrRegister('/register');
loginBtn.onclick=()=>loginOrRegister('/login');

sendBtn.onclick=sendMessage;
txt.addEventListener('keydown',e=>{if(e.key==='Enter') sendMessage();});
function sendMessage(){
  if(!myName)return alert('ابتدا وارد شوید.');
  const text=txt.value.trim();
  if(!text)return;
  socket.emit('send_message',{to:currentTarget,text},res=>{if(!res.ok)alert(res.error||'ارسال ناموفق'); else txt.value='';});
}
</script>

</body>
</html>
